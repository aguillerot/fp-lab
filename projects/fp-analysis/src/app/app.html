@if (isScanning()) {
<lib-qr-scanner
  [deviceId]="selectedCameraId()"
  (qrCodeScanned)="onQrCodeScanned($event)"
  (scanCancelled)="cancelScan()"
  (scanError)="handleScanError($event)"
/>
}

<main class="app-container">
  <div class="content-wrapper">
    <!-- Header -->
    <header class="app-header">
      <h1 class="app-title">Sigma Fp</h1>
      <p class="app-subtitle">Protocol Analysis</p>
    </header>

    <!-- Error Alert -->
    @if (errorMessage(); as msg) {
    <div class="error-banner">
      <mat-icon>error</mat-icon>
      <span>{{ msg }}</span>
    </div>
    }

    <!-- Controls Section -->
    <mat-card class="setup-card">
      <mat-card-header>
        <mat-card-title>Analysis Setup</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-grid">
          <!-- Parameter Name Input -->
          <mat-form-field appearance="outline">
            <mat-label>1. Parameter Name</mat-label>
            <input
              matInput
              placeholder="e.g., ISO, Shutter Speed"
              [ngModel]="parameterName()"
              (ngModelChange)="parameterName.set($event)"
            />
          </mat-form-field>

          <!-- Camera Selection -->
          <mat-form-field appearance="outline">
            <mat-label>2. Select Camera</mat-label>
            @if (availableCameras().length > 0) {
            <mat-select
              [ngModel]="selectedCameraId()"
              (ngModelChange)="selectedCameraId.set($event)"
            >
              @for (camera of availableCameras(); track camera.deviceId; let i = $index) {
              <mat-option [value]="camera.deviceId">
                {{ camera.label || 'Camera ' + (i + 1) }}
              </mat-option>
              }
            </mat-select>
            } @else {
            <input matInput disabled placeholder="No cameras found" />
            }
          </mat-form-field>

          <!-- Value Name Input -->
          <mat-form-field appearance="outline">
            <mat-label>3. Value for Next Scan</mat-label>
            <input
              matInput
              placeholder="e.g., 100, 200, 1/125s"
              [ngModel]="valueName()"
              (ngModelChange)="valueName.set($event)"
            />
          </mat-form-field>

          <!-- Scan Button -->
          <div class="scan-button-wrapper">
            <button
              mat-raised-button
              color="primary"
              [disabled]="!parameterName().trim() || !valueName().trim()"
              (click)="startScan()"
            >
              <mat-icon>qr_code_scanner</mat-icon>
              Scan QR Code
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Results Section -->
    <section class="results-section">
      @let scanSetsData = this.scanSets();
      @if (scanSetsData.size === 0) {
      <mat-card class="empty-card">
        <mat-card-content>
          <div class="empty-state">
            <mat-icon class="empty-icon">inbox</mat-icon>
            <h3>No Data Yet</h3>
            <p>Enter a parameter name and scan your first QR code to begin.</p>
          </div>
        </mat-card-content>
      </mat-card>
      }
      @for (scanSet of scanSetsData; track scanSet[0]) {
        @let paramName = scanSet[0];
        @let bytesDiff = scanSet[1].bytesDiff;
        @let scans = scanSet[1].scans;
        <mat-card class="result-card">
          <mat-card-header>
            <mat-card-title>{{ paramName }}</mat-card-title>
            <button mat-button color="warn" (click)="resetParameter(paramName)">
              <mat-icon>delete</mat-icon>
              Reset Data
            </button>
          </mat-card-header>
          <mat-card-content>
            <table mat-table [dataSource]="scans" class="results-table">
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Value</th>
                <td mat-cell *matCellDef="let scan"><strong>{{ scan.valueName }}</strong></td>
              </ng-container>

              <ng-container matColumnDef="changedBytes">
                <th mat-header-cell *matHeaderCellDef>Changed Bytes ({{ bytesDiff.join(' ') }})</th>
                <td mat-cell *matCellDef="let scan" class="changed-bytes">
                  @if (bytesDiff.length === 0) {
                  <span class="no-change">No change detected</span>
                  } @else {
                  {{ scan.byteData | hexAtIndexes : bytesDiff }}
                  }
                </td>
              </ng-container>

              <ng-container matColumnDef="rawData">
                <th mat-header-cell *matHeaderCellDef>Raw Data (Hex)</th>
                <td mat-cell *matCellDef="let scan" class="raw-data">
                  {{ scan.byteData | bytesToHex }}
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['value', 'changedBytes', 'rawData']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['value', 'changedBytes', 'rawData']"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      }
    </section>
  </div>
</main>
