<p-toast />
<lib-scan-dialog [(visible)]="isScanning" (qrCodeScanned)="onQrCodeScanned($event)"></lib-scan-dialog>

<main class="app-container">
  <div class="content-wrapper flex flex-col gap-4">
    <!-- Header -->
    <header class="app-header">
      <h1 class="app-title">Sigma Fp</h1>
      <p class="app-subtitle">Qr Code Analysis</p>
    </header>

    <!-- Error Alert -->
    @if (errorMessage(); as msg) {
    <p-message severity="error" size="large" icon="pi pi-exclamation-circle">{{ msg }}</p-message>
    }

    <!-- Controls Section -->
    <p-card header="Analysis Setup">
      <div class="flex flex-col gap-4 mt-4 mb-4">
        <!-- Parameter Name Input -->
        <p-iftalabel class="flex-1">
          <input
            id="username"
            pInputText
            [field]="settingsForm.parameterName"
            [class.p-invalid]="settingsForm.parameterName().invalid() && settingsForm.parameterName().touched()"
            class="w-full max-w-90"
          />
          <label for="username">Parameter Name</label>
        </p-iftalabel>

        <!-- Value Name Input -->
        <p-iftalabel class="flex-1">
          <input
            pInputText
            id="valueName"
            [field]="settingsForm.valueName"
            [class.p-invalid]="settingsForm.valueName().invalid() && settingsForm.valueName().touched()"
            class="w-full max-w-90"
          />
          <label for="valueName">Parameter Value</label>
        </p-iftalabel>
      </div>

      <!-- Scan Button -->
      <div class="scan-button-wrapper">
        <p-button
          label="Scan QR Code"
          icon="pi pi-qrcode"
          [disabled]="settingsForm().invalid()"
          (onClick)="startScan()"
        />
      </div>
    </p-card>

    <!-- Results Section -->
    <section class="results-section">
      @let scanSetsData = this.scanSets(); @if (scanSetsData.size === 0) {
      <p-card class="empty-card" header="No Data Yet">
        <p>Enter a parameter name and scan your first QR code to begin.</p>
      </p-card>
      } @for (scanSet of scanSetsData; track scanSet[0]) { @let paramName = scanSet[0]; @let bytesDiff =
      scanSet[1].bytesDiff; @let scans = scanSet[1].scans;
      <p-card class="result-card" [header]="paramName">
        <ng-template #footer>
          <div class="flex gap-4 mt-1">
            <p-button
              label="Reset Data"
              icon="pi pi-trash"
              severity="danger"
              class="w-full"
              styleClass="w-full"
              [text]="true"
              (onClick)="resetParameter(paramName)"
            />
          </div>
        </ng-template>

        <p-table [value]="scans" styleClass="p-datatable-sm p-datatable-striped">
          <ng-template #header>
            <tr>
              <th>Value</th>
              <th>Changed Bytes ({{ bytesDiff.join(' ') }})</th>
              <th>Raw Data</th>
            </tr>
          </ng-template>
          <ng-template #body let-scan>
            <tr>
              <td><strong>{{ scan.valueName }}</strong></td>
              <td class="changed-bytes">
                @if (bytesDiff.length === 0) {
                <span>No change detected</span>
                } @else { {{ scan.byteData | hexAtIndexes : bytesDiff }} }
              </td>
              <td>
                <p-button
                  label="View"
                  icon="pi pi-eye"
                  [text]="true"
                  size="small"
                  (onClick)="showRawData(scan.byteData)"
                />
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
      }
    </section>
  </div>
</main>

<!-- Raw Data Dialog -->
<p-dialog
  header="Raw Data (Hex)"
  [(visible)]="rawDataDialogVisible"
  [modal]="true"
  [style]="{ width: '90vw', maxWidth: '600px' }"
  [dismissableMask]="true"
>
  @if (selectedRawData(); as data) {
  <div class="raw-data-content">{{ data | bytesToHex }}</div>
  }
</p-dialog>
