name: Merge develop to main on release

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create (or reuse) PR from develop to main
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          PR_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')

          if [[ -z "$PR_NUMBER" ]]; then
            gh pr create \
              --base main \
              --head develop \
              --title "Release ${VERSION}" \
              --body "Automated release PR for ${VERSION}

            This PR was created automatically when release ${VERSION} was published.

            ---
            After merge, the deploy workflow will be triggered automatically."
            PR_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          fi

          if [[ -z "$PR_NUMBER" ]]; then
            echo "Failed to find or create PR from develop to main." >&2
            exit 1
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

      - name: Enable auto-merge (protected main)
        run: |
          # Auto-merge lets GitHub merge once required checks/conditions are met.
          # If auto-merge is not enabled in the repo settings, this will fail.
          gh pr merge "$PR_NUMBER" --merge --auto --delete-branch=false || \
            gh pr merge "$PR_NUMBER" --merge --delete-branch=false

      - name: Wait for PR to be merged
        run: |
          # If branch protection requires approvals and none are granted, this will time out.
          deadline=$((SECONDS + 900))
          while (( SECONDS < deadline )); do
            merged=$(gh pr view "$PR_NUMBER" --json merged --jq '.merged')
            if [[ "$merged" == "true" ]]; then
              echo "PR $PR_NUMBER merged."
              exit 0
            fi
            state=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
            echo "PR $PR_NUMBER not merged yet (state: $state). Waiting..."
            sleep 10
          done

          echo "Timed out waiting for PR $PR_NUMBER to merge." >&2
          gh pr view "$PR_NUMBER" --json url,state,mergeable,reviewDecision,statusCheckRollup \
            --jq '{url,state,mergeable,reviewDecision,statusChecks:(.statusCheckRollup|length)}'
          exit 1

      - name: Trigger deploy workflow
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          gh workflow run deploy-fp-manager.yml --ref main -f version="$VERSION"
